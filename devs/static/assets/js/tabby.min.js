!function(t){t.fn.tabby=function(e){var n=t.extend({},t.fn.tabby.defaults,e),a=t.fn.tabby.pressed;return this.each(function(){var e=t(this),r=t.meta?t.extend({},n,e.data()):n;e.bind("keydown",function(e){var n=t.fn.tabby.catch_kc(e);if(16===n&&(a.shft=!0),17===n&&(a.ctrl=!0,setTimeout(function(){t.fn.tabby.pressed.ctrl=!1},1e3)),18===n&&(a.alt=!0,setTimeout(function(){t.fn.tabby.pressed.alt=!1},1e3)),9===n&&!a.ctrl&&!a.alt)return e.preventDefault(),a.last=n,setTimeout(function(){t.fn.tabby.pressed.last=null},0),function(e,n,a){var r=e.scrollTop;e.setSelectionRange?function(t,e,n){var a=t.selectionStart,r=t.selectionEnd;if(a===r)e?a-n.tabString===t.value.substring(a-n.tabString.length,a)?(t.value=t.value.substring(0,a-n.tabString.length)+t.value.substring(a),t.focus(),t.setSelectionRange(a-n.tabString.length,a-n.tabString.length)):a-n.tabString===t.value.substring(a,a+n.tabString.length)&&(t.value=t.value.substring(0,a)+t.value.substring(a+n.tabString.length),t.focus(),t.setSelectionRange(a,a)):(t.value=t.value.substring(0,a)+n.tabString+t.value.substring(a),t.focus(),t.setSelectionRange(a+n.tabString.length,a+n.tabString.length));else{for(;a<t.value.length&&t.value.charAt(a).match(/[ \t]/);)a++;var g=t.value.split("\n"),l=[],i=0,s=0,b=0;for(b in g)s=i+g[b].length,l.push({start:i,end:s,selected:i<=a&&s>a||s>=r&&i<r||i>a&&s<r}),i=s+1;var o=0;for(b in l)if(l[b].selected){var u=l[b].start+o;e&&n.tabString===t.value.substring(u,u+n.tabString.length)?(t.value=t.value.substring(0,u)+t.value.substring(u+n.tabString.length),o-=n.tabString.length):e||(t.value=t.value.substring(0,u)+n.tabString+t.value.substring(u),o+=n.tabString.length)}t.focus();var c=a+(o>0?n.tabString.length:o<0?-n.tabString.length:0),h=r+o;t.setSelectionRange(c,h)}}(e,n,a):document.selection&&function(e,n,a){var r=document.selection.createRange();if(e===r.parentElement())if(""===r.text)if(n){var g=r.getBookmark();r.moveStart("character",-a.tabString.length),a.tabString===r.text?r.text="":(r.moveToBookmark(g),r.moveEnd("character",a.tabString.length),a.tabString===r.text&&(r.text="")),r.collapse(!0),r.select()}else r.text=a.tabString,r.collapse(!1),r.select();else{var l=r.text,i=l.length,s=l.split("\r\n"),b=document.body.createTextRange();b.moveToElementText(e),b.setEndPoint("EndToStart",r);var o=b.text,u=o.split("\r\n"),c=o.length,h=document.body.createTextRange();h.moveToElementText(e),h.setEndPoint("StartToEnd",r);var S=h.text,f=document.body.createTextRange();f.moveToElementText(e),f.setEndPoint("StartToEnd",b);var d=f.text,v=t(e).html();t("#r3").text(c+" + "+i+" + "+S.length+" = "+v.length),c+d.length<v.length?(u.push(""),c+=2,n&&a.tabString===s[0].substring(0,a.tabString.length)?s[0]=s[0].substring(a.tabString.length):n||(s[0]=a.tabString+s[0])):n&&a.tabString===u[u.length-1].substring(0,a.tabString.length)?u[u.length-1]=u[u.length-1].substring(a.tabString.length):n||(u[u.length-1]=a.tabString+u[u.length-1]);for(var m=1;m<s.length;m++)n&&a.tabString===s[m].substring(0,a.tabString.length)?s[m]=s[m].substring(a.tabString.length):n||(s[m]=a.tabString+s[m]);1===u.length&&0===c&&(n&&a.tabString===s[0].substring(0,a.tabString.length)?s[0]=s[0].substring(a.tabString.length):n||(s[0]=a.tabString+s[0])),c+i+S.length<v.length&&(s.push(""),i+=2),b.text=u.join("\r\n"),r.text=s.join("\r\n");var T=document.body.createTextRange();T.moveToElementText(e),0<c?T.setEndPoint("StartToEnd",b):T.setEndPoint("StartToStart",b),T.setEndPoint("EndToEnd",r),T.select()}}(e,n,a);e.scrollTop=r}(t(e.target).get(0),a.shft,r),!1}).bind("keyup",function(e){16===t.fn.tabby.catch_kc(e)&&(a.shft=!1)}).bind("blur",function(e){9===a.last&&t(e.target).one("focus",function(){a.last=null}).get(0).focus()})})},t.fn.tabby.catch_kc=function(t){return t.keyCode?t.keyCode:t.charCode?t.charCode:t.which},t.fn.tabby.pressed={shft:!1,ctrl:!1,alt:!1,last:null},t.fn.tabby.defaults={tabString:String.fromCharCode(9)}}(jQuery);